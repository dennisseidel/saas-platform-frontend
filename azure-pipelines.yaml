# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

pr:
  branches:
    include:
    - master
  paths:
    exclude:
    - README.md
    - /adr/*
    - .adr-dir

pool:
  vmImage: 'Ubuntu-16.04'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '8.x'
  displayName: 'Install Node.js'
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.6'
    architecture: 'x64'
- script: |
    echo 'everything should be there'
  displayName: 'setup credentials & dependencies'
- script: |
    env
    cd ./scripts && python deploy-infrastructure.py -c infrastructure -ni True
  env:
      # PULUMI_ACCESS_TOKEN: $(pulumi.access.token) How to handle terraform remote state?
      AWS_ACCESS_KEY_ID: $(aws.master.accesskey)
      AWS_SECRET_ACCESS_KEY: $(aws.master.accesssecret)
      TF_VAR_AWS_ACCESS_KEY: $(aws.master.accesskey)
      TF_VAR_AWS_SECRET_KEY: $(aws.master.accesssecret)
  displayName: 'setup infrastructure'
- script: |
    cp ./infrastructure/config.json ./src/config.json

- script: |
    npm run e2e
  displayName: 'run test'

- script: |
    # setup preview environment & artifact bucket & upload to artifiact bucket
    npm install && npm run build
    cd ./scripts && ./deploy-infrastructure.py -c website
  env:
      AWS_ACCESS_KEY_ID: $(aws.master.accesskey)
      AWS_SECRET_ACCESS_KEY: $(aws.master.accesssecret)
  displayName: 'Deploy to preview environment'